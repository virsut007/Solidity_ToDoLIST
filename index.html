<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Todo List</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 650px; margin: 2rem auto; padding: 1rem; background: #f4f7f6; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input, select, button { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { cursor: pointer; background: #3498db; color: white; border: none; font-weight: bold; transition: background 0.3s; }
        button:hover { background: #2980b9; }
        .task { background: #fff; border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .completed span { text-decoration: line-through; color: #95a5a6; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; margin-left: 5px; }
        .bg-red { background: #e74c3c; } .bg-yellow { background: #f1c40f; color: #333; } .bg-blue { background: #3498db; }
        #status { text-align: center; margin-bottom: 15px; font-weight: bold; color: #27ae60; min-height: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üîóSolidity Todo List</h1>
        <p style="text-align: center; font-size: 0.9em; color: #7f8c8d;">Running on Sepolia Testnet</p>

        <div style="text-align: center; margin-bottom: 20px;">
            <button id="connectBtn" onclick="connectWallet()">ü¶ä Connect Wallet</button>
            <p id="status"></p>
        </div>

        <div id="app" style="display:none;">
            <div class="input-group">
                <input type="text" id="desc" placeholder="Task Description">
                <select id="priority">
                    <option value="0">Low Priority</option>
                    <option value="1">Medium Priority</option>
                    <option value="2">High Priority</option>
                </select>
                <input type="text" id="category" placeholder="Category">
                <input type="text" id="date" placeholder="Due Date">
                <button onclick="addTask()">‚ûï Add to Blockchain</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <h3>Your Tasks (Sorted by Priority)</h3>
            <div id="taskList">Loading tasks...</div>
        </div>
    </div>

    <script>
        const contractAddress = "0xA719A8edcaa600390fbE2198180c47EA51F576a8"; 
        const abi = [
            {
                "inputs": [
                    { "internalType": "string", "name": "_description", "type": "string" },
                    { "internalType": "enum TodoList.Priority", "name": "_priorityEnum", "type": "uint8" },
                    { "internalType": "string", "name": "_category", "type": "string" },
                    { "internalType": "string", "name": "_dueDate", "type": "string" }
                ],
                "name": "AddTask",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "uint256", "name": "_index", "type": "uint256" } ],
                "name": "DeleteTask",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "uint256", "name": "_index", "type": "uint256" } ],
                "name": "ToggleComplete",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getSortedTasks",
                "outputs": [
                    {
                        "components": [
                            { "internalType": "string", "name": "description", "type": "string" },
                            { "internalType": "bool", "name": "isCompleted", "type": "bool" },
                            { "internalType": "enum TodoList.Priority", "name": "priority", "type": "uint8" },
                            { "internalType": "string", "name": "category", "type": "string" },
                            { "internalType": "string", "name": "dueDate", "type": "string" }
                        ],
                        "internalType": "struct TodoList.Task[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let provider, signer, contract;

        async function connectWallet() {
            try {
                if (!window.ethereum) return alert("Please install MetaMask!");
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0xaa36a7' }],
                    });
                } catch (e) { console.log("Network switch ignored or failed"); }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                contract = new ethers.Contract(contractAddress, abi, signer);

                document.getElementById("connectBtn").style.display = "none";
                document.getElementById("app").style.display = "block";
                document.getElementById("status").innerText = "‚úÖ Connected: " + address.substring(0,6) + "...";
                
                loadTasks();
            } catch (err) {
                console.error(err);
                alert("Connection failed: " + err.message);
            }
        }

        async function addTask() {
            const desc = document.getElementById("desc").value;
            const prio = document.getElementById("priority").value;
            const cat = document.getElementById("category").value;
            const date = document.getElementById("date").value;

            if(!desc) return alert("Description required!");

            try {
                updateStatus("‚è≥ Confirm transaction in MetaMask...");
                const tx = await contract.connect(signer).AddTask(desc, parseInt(prio), cat, date);
                
                updateStatus("‚õìÔ∏è Mining... (Wait 15s)");
                await tx.wait(); 
                
                updateStatus("‚úÖ Task Added!");
                document.getElementById("desc").value = ""; 
                loadTasks();
            } catch (err) {
                console.error(err);
                updateStatus("‚ùå Error: " + (err.reason || err.message));
            }
        }

        async function loadTasks() {
            try {
                const list = document.getElementById("taskList");
                list.innerHTML = "Fetching from Blockchain...";
                
                const tasks = await contract.getSortedTasks();
                
                list.innerHTML = "";
                if(tasks.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#999'>No tasks found.</p>";
                    return;
                }

                tasks.forEach((task, index) => {
                    const div = document.createElement("div");
                    div.className = "task " + (task.isCompleted ? "completed" : "");
                    
                    let badgeClass = "bg-blue";
                    let badgeText = "Low";
                    if(task.priority === 1) { badgeClass = "bg-yellow"; badgeText = "Med"; }
                    if(task.priority === 2) { badgeClass = "bg-red"; badgeText = "High"; }

                    div.innerHTML = `
                        <div>
                            <strong>${task.description}</strong> 
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            <div style="font-size:0.85em; color:#666; margin-top:4px;">
                                ${task.category} ‚Ä¢ Due: ${task.dueDate}
                            </div>
                        </div>
                        <div>
                            <button onclick="toggle(${index})" style="background:#27ae60; padding:5px 10px; font-size:12px;">
                                ${task.isCompleted ? "Task Done" : "Mark as Done"}
                            </button>
                            <button onclick="remove(${index})" style="background:#c0392b; padding:5px 10px; font-size:12px; margin-left:5px;">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (err) {
                console.error("Read Error:", err);
            }
        }

        async function toggle(index) {
            try {
                updateStatus("‚è≥ Confirming...");
                const tx = await contract.connect(signer).ToggleComplete(index);
                await tx.wait();
                loadTasks();
                updateStatus("‚úÖ Updated!");
            } catch(err) { console.error(err); }
        }

        async function remove(index) {
            try {
                updateStatus("‚è≥ Deleting...");
                const tx = await contract.connect(signer).DeleteTask(index);
                await tx.wait();
                loadTasks();
                updateStatus("‚úÖ Deleted!");
            } catch(err) { console.error(err); }
        }

        function updateStatus(msg) {
            document.getElementById("status").innerText = msg;
        }
    </script>
</body>
</html>
